// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 사용자 프로필
model User {
  userId              String    @id @default(uuid()) @map("user_id")
  nickname            String    @db.VarChar(50)
  age                 Int       @db.SmallInt
  language            String    @default("en") @db.VarChar(5)
  country             String?   @db.VarChar(100)
  preferredInputMethod String?  @map("preferred_input_method") @db.VarChar(20) // 'text', 'voice', 'mixed'
  createdAt           DateTime  @default(now()) @map("created_at")
  lastActive          DateTime? @map("last_active")

  // Relations
  conversationSessions ConversationSession[]
  userProfiles         UserProfile[]
  selectedCareers      UserSelectedCareer[]
  visionBoardImages    VisionBoardImage[]
  feedback             UserFeedback[]

  @@map("users")
}

// 대화 세션
model ConversationSession {
  sessionId   String   @id @default(uuid()) @map("session_id")
  userId      String   @map("user_id")
  startedAt   DateTime @default(now()) @map("started_at")
  completedAt DateTime? @map("completed_at")
  status      String   @db.VarChar(20) // 'in_progress', 'completed', 'abandoned'
  language    String?  @db.VarChar(5)

  // Relations
  user        User     @relation(fields: [userId], references: [userId], onDelete: Cascade)
  messages    ConversationMessage[]
  userProfiles UserProfile[]
  feedback    UserFeedback[]

  @@map("conversation_sessions")
}

// 대화 메시지
model ConversationMessage {
  messageId      String   @id @default(uuid()) @map("message_id")
  sessionId      String   @map("session_id")
  role           String   @db.VarChar(20) // 'user', 'assistant'
  content        String   @db.Text
  inputMethod    String?  @map("input_method") @db.VarChar(20) // 'text', 'voice'
  timestamp      DateTime @default(now())
  geminiMetadata Json?    @map("gemini_metadata") // Gemini API 응답 메타데이터

  // Relations
  session        ConversationSession @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)

  @@map("conversation_messages")
}

// 사용자 프로필 분석 결과
model UserProfile {
  profileId          String   @id @default(uuid()) @map("profile_id")
  userId             String   @map("user_id")
  sessionId          String?  @map("session_id")
  interests          String[]
  strengths          String[]
  values             String[]
  learningStyle      String?  @map("learning_style") @db.VarChar(50)
  motivationLevel    Int?     @map("motivation_level") @db.SmallInt // 1-10
  careerPreferences  Json?    @map("career_preferences")
  mentalHealthFlags  String[] @map("mental_health_flags")
  analysisCompletedAt DateTime @default(now()) @map("analysis_completed_at")
  geminiAnalysisRaw   Json?    @map("gemini_analysis_raw")

  // Relations
  user                User     @relation(fields: [userId], references: [userId], onDelete: Cascade)
  session             ConversationSession? @relation(fields: [sessionId], references: [sessionId])
  careerRecommendations CareerRecommendation[]

  @@map("user_profiles")
}

// 진로 추천
model CareerRecommendation {
  recommendationId String   @id @default(uuid()) @map("recommendation_id")
  profileId        String   @map("profile_id")
  careerPathId     String   @map("career_path_id") @db.VarChar(50) // 'path_1', 'path_2', 'custom_xxx'
  careerName       String   @map("career_name") @db.VarChar(200)
  description      String?  @db.Text
  matchReason      String?  @map("match_reason") @db.Text
  skillsNeeded     String[] @map("skills_needed")
  exampleJobs      String[] @map("example_jobs")
  educationPath    String?  @map("education_path") @db.Text
  growthPotential  String?  @map("growth_potential") @db.Text
  isCustom         Boolean  @default(false) @map("is_custom")
  displayOrder     Int?     @map("display_order")
  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  profile          UserProfile @relation(fields: [profileId], references: [profileId], onDelete: Cascade)
  selectedCareers  UserSelectedCareer[]
  visionBoardImages VisionBoardImage[]

  @@map("career_recommendations")
}

// 사용자가 선택한 진로
model UserSelectedCareer {
  selectionId     String   @id @default(uuid()) @map("selection_id")
  userId          String   @map("user_id")
  recommendationId String  @map("recommendation_id")
  selectedAt      DateTime @default(now()) @map("selected_at")
  isFavorite      Boolean  @default(false) @map("is_favorite")

  // Relations
  user            User     @relation(fields: [userId], references: [userId], onDelete: Cascade)
  recommendation  CareerRecommendation @relation(fields: [recommendationId], references: [recommendationId])

  @@map("user_selected_careers")
}

// 비전 보드 이미지
model VisionBoardImage {
  imageId           String   @id @default(uuid()) @map("image_id")
  userId            String   @map("user_id")
  recommendationId  String?  @map("recommendation_id")
  style             String   @db.VarChar(50) // 'id_badge', 'magazine_cover', 'achievement'
  imageUrl          String   @map("image_url") @db.Text
  geminiPrompt      String?  @map("gemini_prompt") @db.Text
  generatedAt       DateTime @default(now()) @map("generated_at")
  safetyCheckPassed Boolean  @default(true) @map("safety_check_passed")

  // Relations
  user              User     @relation(fields: [userId], references: [userId], onDelete: Cascade)
  recommendation   CareerRecommendation? @relation(fields: [recommendationId], references: [recommendationId])

  @@map("vision_board_images")
}

// 사용자 피드백
model UserFeedback {
  feedbackId   String   @id @default(uuid()) @map("feedback_id")
  userId       String   @map("user_id")
  sessionId    String?  @map("session_id")
  rating       Int      @db.SmallInt // 1-5
  feedbackText String?  @map("feedback_text") @db.Text
  feedbackType String?  @map("feedback_type") @db.VarChar(50) // 'conversation', 'recommendation', 'overall'
  submittedAt  DateTime @default(now()) @map("submitted_at")

  // Relations
  user         User     @relation(fields: [userId], references: [userId], onDelete: Cascade)
  session      ConversationSession? @relation(fields: [sessionId], references: [sessionId])

  @@map("user_feedback")
}
